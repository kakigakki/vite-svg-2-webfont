import{promisify as V}from"util";import{relative as q}from"path";import $ from"@vusion/webfonts-generator";import{constants as A}from"fs";import{resolve as H,dirname as M}from"path";import{watch as N,access as _,mkdir as U,writeFile as C}from"fs/promises";var b,F={eot:"application/vnd.ms-fontobject",svg:"image/svg+xml",ttf:"application/x-font-ttf",woff:"application/font-woff",woff2:"font/woff2"};async function D(e,t){let n=H(e,t);try{return await _(n,A.R_OK),!0}catch{return!1}}async function L(e,{eventType:t,filename:n},r,l=D){t!=="rename"||!n.endsWith(".svg")||!await l(e,n)||r({eventType:t,filename:n})}async function v(e,t,n){try{b=N(e,{signal:t});for await(let r of b)L(e,r,n)}catch(r){if(r.name==="AbortError")return;throw r}}var w="qwertyuiopasdfghjklzxcvbnmQWERTYUIOPASDFGHJKLZXCVBNM1234567890";function O(e=8){let t="";for(let n=0;n<e;n++){let r=Math.floor(Math.random()*w.length);t+=w[r]}return t}function E(e){var n;return!!((n=/(?:\.([^.]+))?$/.exec(e||""))!=null&&n[1])}async function h(e,t){let n={mode:511,recursive:!0};await U(M(t),n),await C(t,e)}import k from"glob";import{resolve as f}from"path";var m=class extends Error{},p=class extends Error{constructor(t){super(`WriteFiles option received invalid types: ${t.join(", ")}`)}};var{sync:z}=k,I=["html","css","fonts"];function Y({types:e}){return Array.isArray(e)?e:e?[e]:["eot","woff","woff2","ttf","svg"]}function T({files:e,context:t}){e||=["*.svg"];let n=e.flatMap(r=>z(r,{cwd:t})).map(r=>`${t}/${r}`);if(!n.length)throw new m("The specified file globs did not resolve any files in the context.");return n}function P(e,t,n,r){return t?E(t)?f(e,t):f(e,t,`${n.toLowerCase()}.${r}`):f(e,`${n.toLowerCase()}.${r}`)}function j({generateFiles:e}){if(!e||typeof e=="boolean")return e?I:[];Array.isArray(e)||(e=[e]);let t=e.filter(n=>!I.includes(n));if(t.length)throw new p(t);return e}function B(e){let t=new Set(j(e));return{fonts:t.has("fonts"),html:t.has("html"),css:t.has("css")}}function G(e){let t=Y(e),n=T(e),r=B(e);return e.dest||=f(e.context,"..","artifacts"),e.fontName||="iconfont",{files:n,types:t,order:t,fontName:e.fontName,fontHeight:e.fontHeight||1e3,codepoints:e.codepoints||{},templateOptions:{baseSelector:e.baseSelector||".icon",classPrefix:e.classPrefix??"icon-"},html:r.html,css:r.css,ligature:e.ligature??!0,formatOptions:e.formatOptions||{},dest:e.dest.endsWith("/")?e.dest:`${e.dest}/`,writeFiles:r.fonts,cssDest:P(e.dest,e.cssDest,e.fontName,"css"),htmlDest:P(e.dest,e.htmlDest,e.fontName,"html"),...e.cssTemplate&&{cssTemplate:f(e.dest,e.cssTemplate)},...e.cssFontsUrl&&{cssFontsUrl:f(e.dest,e.cssFontsUrl)},...e.htmlTemplate&&{htmlTemplate:f(e.dest,e.htmlTemplate)},...typeof e.fixedWidth<"u"&&{fixedWidth:e.fixedWidth},...typeof e.centerHorizontally<"u"&&{centerHorizontally:e.centerHorizontally},...typeof e.normalize<"u"&&{normalize:e.normalize},...typeof e.round<"u"&&{round:e.round},...typeof e.descent<"u"&&{descent:e.descent}}}import K from"jssha";var W=new AbortController,X=V($),R="virtual:vite-svg-2-webfont.css",u=`\0${R}`;function J(e){let t=G(e),n,r,l,g,o,y=async i=>{i&&(t.files=T(e)),n&&(t.writeFiles=!1),o=await X(t);let a=!t.writeFiles&&(t.css||t.html);if(!n&&a){let s=[];t.css&&s.push(h(o.generateCss(),t.cssDest)),t.html&&s.push(h(o.generateHtml(),t.htmlDest)),await Promise.all(s)}if(i){let s=l==null?void 0:l.getModuleById(u);s&&g&&g(s)}};return{name:"vite-svg-2-webfont",enforce:"pre",configResolved(i){n=i.command==="build"},resolveId(i){if(i===R)return u},transform(i,a){var s;if(a===u)return((s=o==null?void 0:o.generateCss)==null?void 0:s.call(o,r))||""},load(i){if(i===u)return u},async buildStart(){if(n||v(e.context,W.signal,()=>y(!0)),await y(),n){let i;if(t.cssFontsUrl){let s=q(t.dest,t.cssFontsUrl);i=s===""?".":`./${s}`}else i="/assets";let a=t.types.map(s=>{let d=o!=null&&o[s]?new K("SHA-256","UINT8ARRAY").update(o[s]).getHash("HEX").substring(0,8):O();return[s,`/${this.getFileName(this.emitFile({type:"asset",fileName:`assets/${t.fontName}-${d}.${s}`,source:o==null?void 0:o[s]}))}`.replace("/assets",i)]});r=Object.fromEntries(a)}},configureServer({middlewares:i,reloadModule:a,moduleGraph:s}){for(let d of t.types){let S=`${t.fontName}.${d}`;i.use(`/${S}`,(Q,c)=>{if(l=s,g=a,!o)return c.statusCode=404,c.end();let x=o[d];return c.setHeader("content-type",F[d]),c.setHeader("content-length",x.length),c.statusCode=200,c.end(x)})}},buildEnd(){W.abort()}}}var ge=J,he=$.templates;export{ge as default,he as templates,J as viteSvgToWebfont};
